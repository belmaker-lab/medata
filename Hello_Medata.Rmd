---
title: "Data acquaintance for Mediterranean dataset (MEData)"
author: "Shira Salingré"
output: 
  html_document:
    theme: lumen
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
date: "`r format(Sys.time(), '%Y-%m-%d')`"
---

```{r setup, include=FALSE}
library(sf)
library(tidyverse)

```

# Introduction
MEData is a dataset of underwater fish census surveys conducted along the Mediterranean sea. The dataset includes environmental variables, as well as conservation information regarding MPAs.


```{r setup data}
medata <- read_rds("data/medata.Rds")

```

# Variables

| variable         | type  | comments                             |
| :--------------- | :---: | :------------------------------------|
| `data.origin`    | *fct* | azz_asi = Azzuro; azz_malta = Azzuro; Belmaker = Belmaker; Claudet = Claudet; Sala - PEW = Enric Sala; Periklis_MER = Periklis Kleitou, MER Lab | 
| `country`        | *fct* | Country where `site` is located |
| `season`         | *fct* | The season in which the survey was conducted; levels: `Autumn`, `Spring`, `Summer` |
| `lon`            | *num* | longitude (decimal degrees); approximate for Linosa, Kornati|
| `lat`            | *num* | latitude (decimal degrees); approximate for Linosa, Kornati |
| `site`           | *fct* | site name |
| `trans`          | *int* | transect number |
| `unique_trans_id`| *int* | unique identifier for each transect (unique site + transect + coordinates + depth) |
| `protection`     | *lgl* | inside MPA/unfished (`TRUE`) or outside MPA/fished (`FALSE`); linked to `enforcement` level |
| `enforcement`    | *int* | type of enforcement. 3 levels: `1` = Minimal enforcement; `2` = Medium enforcement; `3` = Fully protected (strongest enforcement). Complements `protection` |
| `total.mpa.ha`   | *num* | total MPA area in hactare; [Source for Ustica](http://www.parks.it/indice/RM/Eindex.php); [Source for Marettimo](http://www.ampisoleegadi.it/?idx=1620) |
| `size.notake`    | *num* | area size of no-take zone (in ha); [Source for Ustica](http://www.mmmpa.eu/UST-MPA.asp) |
| `yr.creation`    | *int* | MPA establishment year |
| `age.reserve.yr` | *int* | age of the MPA in years (corresponds to `yr.creation`) at the time of survey |
| `depth`          | *num* | depth of survey in meters |
| `tmean`          | *num* | annual mean sea surface temperature temperature (Source: [Bio-ORACLE](http://www.bio-oracle.org/index.php)) |
| `sal_mean`       | *num* | annual mean salinity (Source: [Bio-ORACLE](http://www.bio-oracle.org/index.php)) |
| `pp_mean`        | *num* | annual mean primary productivity (Source: [Bio-ORACLE](http://www.bio-oracle.org/index.php)) |
| `species`        | *fct* | species scientific name (format: *Genus.species*); some species are identified to Genus level (includes 'spp' suffix)  or family level (includes -dae suffix) |
| `sp.n`           | *int* | fish count - how many individuals of this species were observed? |
| `sp.length`      | *num* | length of fish in cm |
| `a`              | *num* | species length-weight relationship constant (Source: [FishBase](https://www.fishbase.de/summary/citation.php); Type = TL; using method 'Type I linear regression') |
| `b`              | *num* | species length-weight relationship constant (Source: [FishBase](https://www.fishbase.de/summary/citation.php); Type = TL; using method 'Type I linear regression') |
| `family`         | *fct* | taxonomic family  |
| `exotic`         | *lgl* | whether this species is local (indigenous, `FALSE`) or introduced (lessepsian migrant, `TRUE`) |
| `FoodTroph`      | *num* | trophic level of the species. Extracted from [FishBase](https://www.fishbase.de/summary/citation.php)
| `FoodSeTroph`    | *num* | standard error for trophic level calculation (`FoodTroph`. Extracted from [FishBase](https://www.fishbase.de/summary/citation.php)  

- *Data types: num = decimal number; fct = factor; lgl = logical  

# Overview

```{r}
summary(medata)
skimr::skim(medata)
```

## Countries

Data was collected from 9 countries:

```{r review the dataset}
medata %>% distinct(country) %>% arrange(.$country) %>% print(n = Inf)

```

## Sites

Data was collected from 72 sites:
```{r include=FALSE}
medata %>% 
  dplyr::select(lon, lat, country, site) %>% 
  dplyr::distinct(lon, lat, .keep_all = TRUE) %>%
  dplyr::distinct(site) %>%
  print(n = Inf)

```

## Species

Dataset withholds 124 species
```{r}
medata %>% distinct(species) %>% arrange(.$species) %>% count()

# proper species
medata %>% distinct(species) %>% arrange(.$species) %>%
  filter(!c(grepl("dae", species) | grepl(".spp", species))) %>%
  print(n = Inf)

```
**NOTE**: There are 135 taxa in the dataset but some are not species but genus (Atherina.spp, Symphodus.spp etc.) or family (Labridae, Clupeidae, Belonidae etc.).  

# Methods

## Data collection
Visual fish census surveys took place between the years 2009-2019 in multiple locations along the Mediterranean Sea (figure 1) by teams of skilled SCUBA divers. Locations were comprised of sites within MPAs with varying size, age and enforcement level, and unprotected sites which are adjacent to these MPAs. To date, the database consists of 44,754 observations, in 2,270 transects, of 135 species of fish and includes mostly abundance data.

```{r locations map, echo=FALSE}
med_map <- sf::st_read("Med_World_Seas_IHO_v3_MarineRegions/Medit_seas_IHO.shp", quiet = TRUE)

ggplot(medata) +
  geom_sf(data = med_map$geometry, mapping = aes()) +
  geom_point(aes(x = lon, y = lat, fill = tmean), colour = "black", pch = 21,
             size = 5, alpha = 0.7) +
  fishualize::scale_fill_fish(option = "Serranus_scriba", direction = -1) +
  ggtitle(label = "Mediterranean fish surveys", subtitle = "Locations and temperatures") +
  xlab("Longitude") + 
  ylab("Latitude") +
  labs(fill = "Mean Annual Temp")

```  

Figure 1. Survey sites and temperatures (in degrees celsius).

The sampling protocol is described in [Frid Ori, et al., 2022]( https://doi.org/10.12681/mms.26423).

## Data acquired from other resources

**Environmental data** (temperature, salinity and primary production) were acquired from [Bio-ORACLE](http://http://www.bio-oracle.org) using `sdmpredictors` package.

__Layers__:

- tmean = "BO_sstmean"
- sal_mean = "BO2_salinitymean_ss"
- pp_mean = "BO2_ppmean_ss"

(See ["R/bio-oracle extraction code.R"](https://github.com/belmaker-lab/medata/blob/master/R/bio-oracle%20extraction%20code.R) for full extraction code).


## Data wrangling notes

* Linosa and kornati did not have specific coordinates, therefore, an approximate location (lat-lon) was attached to it. If your analysis requires fine-detail for the location, you might want to omit these locations.

* Data from source `asinara_add` site are presence-absence only.


# Transformations
Many analyses require species matrix where each row is a site and each column is a species.

Here's the code to create such matrix with this dataset:

```{r create species matrix, class.source = 'foldable'}

# Create a species matrix with where rows are transects and columns are species
# (id_cols can be minimised but I keep it for explicitness)
med_mat <- medata %>%
  pivot_wider(id_cols = c(data.origin, country, season, lon, lat, site, trans, unique_trans_id, protection, enforcement, total.mpa.ha, size.notake, yr.creation, age.reserve.yr, depth, tmean, sal_mean, pp_mean), 
              names_from = species, values_from = sp.n, 
              values_fn = function(x) sum(x, na.rm = T), values_fill = 0)

# Convert the abundance data to pseudo presence-absence
pres_abs_mat <- med_mat
first_species <- which(colnames(med_mat) == "Atherina.boyeri")
pres_abs_mat[first_species:ncol(pres_abs_mat)] <- ifelse(pres_abs_mat[first_species:ncol(pres_abs_mat)] > 0, 1, 0)


```

Just pay attention that here there is also metadata in the left columns (until the first species). Some ecological anaylses require the data to be a real matrix (only made of one type of data - the abundance of each species), and in this case just make sure you separate the meta-data from the species matrix.

# View the data

## Species richness
```{r}
col_scale <- fishualize::fish(n = 9, option = "Thalassoma_pavo")
medata %>% 
  group_by(country, lon, lat) %>% 
  distinct(species) %>% summarise(richness = n()) %>% 
  ggplot() +
  geom_sf(data = med_map$geometry) +
  geom_point(aes(x = lon, y = lat, size = richness, col = country), pch = 21, alpha = 0.4) +
  scale_colour_manual(values = col_scale, name = "Country") +
  labs(x = "", y = "", size = "Richness")
```

## Lessepsian migrants
```{r}
medata %>% filter(!is.na(exotic)) %>% 
  ggplot() + aes(x = exotic) + geom_bar(fill = c("#62a1c7", "#d53748")) +
  labs(x = "Exotic (Lessepsian migrant)", y = "Total observations count")

medata %>% filter(!is.na(exotic)) %>% distinct(species, exotic) %>% 
  ggplot() + aes(x = exotic) + geom_bar(fill = c("#62a1c7", "#d53748")) +
  labs(x = "Exotic (Lessepsian migrant)", y = "Total species count")

```

# References

Froese, R. and D. Pauly. Editors. 2021.FishBase. World Wide Web electronic publication. www.fishbase.org, (06/2021)

Boettiger C, Temple Lang D, Wainwright P (2012). “rfishbase: exploring, manipulating and visualizing FishBase data from R.” Journal of Fish Biology

Assis J, Tyberghein L, Bosch S, Heroen V, SerrÃ£o E, De Clerck O, Tittensor D (2018). Bio-ORACLE v2.0: Extending marine data layers for bioclimatic modelling." _Global Ecology and Biogeography_, *27*(3),277-284. doi: 10.1111/geb.12693 (https://doi.org/10.1111/geb.12693). 

Tyberghein L, Heroen V, Pauly K, Troupin C, Mineur F, De Clerck O (2012). Bio-ORACLE: a global environmental dataset for marine speciesdistribution modelling.\" _Global Ecology and Biogeography_, *21*(2),272-281. doi: 10.1111/j.1466-8238.2011.00656.x (https://doi.org/10.1111/j.1466-8238.2011.00656.x).

