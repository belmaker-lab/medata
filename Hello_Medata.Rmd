---
title: "Data acquaintance for Mediterranean dataset (Medata)"
author: "Shira Salingr√©"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
library(sf)
library(plotly)
library(tidyverse)

```

# Introduction
Medata is a dataset of Mediterranean fish census surveys conducted along the Mediterranean sea. The dataset includes environmental variables as well as conservation information regarding MPAs.

This is a collaboration of [Belmaker Lab](https://belmaker.weebly.com/) (Tel Aviv University, Israel), [Ernesto Azzuro](https://www.researchgate.net/profile/Ernesto_Azzurro) (ISPRA, Italy), [Joachim Claudet](http://www.joachimclaudet.com/) (CNRS, France) and [Enric Sala](https://www.researchgate.net/profile/Enric_Sala).


```{r setup data}
raw_med <- read.csv("med_raw.csv", na.strings = c("", "NA")) # na.string() is used to make sure all blanks and all NAs are counted as NA.

# locations will be a subset of unique sites: sites that have unique longitude and latitude
locations <- raw_med %>% 
  select(lon, lat, country, site) %>% 
  distinct(lon, lat, .keep_all = TRUE)

```

# Variables

| variable       | type  | comments                             |
| :------------- | :---: | :------------------------------------|
|  `data.origin` | *fct* | azz_asi = Azzuro; azz_malta = Azzuro; Belmaker = Belmaker; Claudet = Claudet; Sala - PEW = Sala |
| `country`      | *fct* | Country where `site` is located |
| `sites`        | *fct* | site names   |
| `lon`          | *num* | longitude (degrees); approximate for Linosa, Kornati|
| `lat`          | *num* | latitude (degrees); approximate for Linosa, Kornati |
| `trans`        | *int* | transect number |
| `species`      | *fct* | species scientific name (*Genus.species*); some species are recognised to Genus (spp)  or Family (-dae suffix) level |
| `sp.length`    | *num* | length of fish in cm |
| `sp.n`         | *int* | fish count - how many individuals of this species were observed? |
| `season`       | *fct* | levels: `Autumn`, `Spring`, `Summer` - The season in which the survey was conducted |
| `protection`   | *fct* | inside MPA = `YES`; outside MPA = `NO` |
| `enforcement`  | *int* | type of enforcement. 3 levels: `1` = Minimal protection; `2` = Medium protection; `3` = Fully protected. Complements `protection` |
| `total.mpa.ha` | *num* | total MPA area in hactare; [Source for Ustica](http://www.parks.it/indice/RM/Eindex.php); [Source for Marettimo](http://www.ampisoleegadi.it/?idx=1620) |
| `size.notake`  | *num* | area size of no-take zone (in ha); [Source for Ustica](http://www.mmmpa.eu/UST-MPA.asp) |
| `yr.creation`  | *int* | MPA establishment year |
| `age.reserve.yr`| *int* | age of the MPA in years (corresponds to `yr.creation`) |
| `depth`        | *num* | depth of survey in metres (where applicable) |
| `a`            | *num* | species length-weight relationship constant |
| `b`            | *num* | species length-weight relationship constant |
| `tmean`        | *num* | annual mean temperature (Source: [Bio-ORACLE](http://www.bio-oracle.org/index.php)) |
| `trange`       | *num* | annual temperature range (Source: [Bio-ORACLE](http://www.bio-oracle.org/index.php)) |
| `sal_mean`     | *num* | annual mean salinity (Source: [Bio-ORACLE](http://www.bio-oracle.org/index.php)) |
| `pp_mean`      | *num* | annual mean primary productivity (Source: [Bio-ORACLE](http://www.bio-oracle.org/index.php)) |
| `pp_range`     | *num* | annual primary production range (Source: [Bio-ORACLE](http://www.bio-oracle.org/index.php)) |

# Methods

## Data collection
Visual fish census surveys took place in 57 locations along the Mediterranean Sea (figure 1) by teams of skilled SCUBA divers. Locations were comprised of sites within MPAs with varying size, age and enforcement level, and unprotected sites which are adjacent to these MPAs. To date, the database is comprised of approximately 49,000 observations of 93 species of fish and includes abundance data, as well as presence-absence data. Additional data will be collected during 2019 and will be added to the main database.

```{r locations map}
med_map <- sf::st_read("Med_World_Seas_IHO_v3_MarineRegions/Medit_seas_IHO.shp")

sites_plot <- ggplot(raw_med) +
  geom_sf(data = med_map$geometry, mapping = aes()) +
  geom_point(aes(x = lon, y = lat, col = tmean)) +
  scale_colour_brewer(palette = "RdBu", aesthetics = "fill")

sites_plot

```

Figure 1. Survey sites.


```{r review the dataset}
summary(raw_med) # examine raw data and check for errors.

raw_med %>% distinct(country) # check full country list
raw_med %>% distinct(site) # check full site list
raw_med %>% distinct(species) # check full species list. NOTE: some are not species but genus or family.

```

## Data cleaning

* Linosa and kornati did not have specific coordinates, therefore, an approximate location (lat-lon) was attached to it. If your analysis requires fine-detail for the location, you might want to omit these locations.

* 

## Data wrangling

### Acquiring data from other resources

Environmental data (temperature, salinity and primary production) were acquired from [Bio-ORACLE](http://http://www.bio-oracle.org) using `sdmpredictors` package.

Fish traits data ("fish_traits.csv" including: Size, Mobility, Activity, Schooling, Position, Diet) was aqcuired from [GASPAR](http://cesab.org/index.php/en/projets-passes/28-gaspar). Where data was unavailable we used the information from [Trait structure reveals the processes underlying fish establishment in the Mediterranean
O Givan, V Parravicini, M Kulbicki, J Belmaker - Global ecology and biogeography, 2017](https://onlinelibrary.wiley.com/doi/full/10.1111/geb.12523). For some species no data was available, therefore they are not included.

Species with NA values:
* Chelon.labrosus
* Ctenolabrus.rupestris
* Dicentrarchus.labrax
* Dicentrarchus.punctatus
* Gobius.auratus
* Gobius.cobitis
* Gobius.geniporus
* Gobius.paganellus
* Gobius.vittatus
* Labrus.merula
* Labrus.viridis
* Lichia.amia
* Liza.aurata
* Mullus.barbatus
* Myliobatis.aquila
* Oedalechilus.labeo
* Phycis.phycis
* Pomatomus.saltatrix
* Pomatoschistus.quagga
* Symphodus.cinereus
* Symphodus.ocellatus
* Symphodus.rostratus
* Trachurus.mediterraneus
* Tripterygion.tripteronotus
* Trisopterus.minutus

*Size* coded as an ordered categorical variable with 6 levels:
1. S1 = 0-7cm
2. S2 = 7.1-15cm
3. S3 = 15.1- 30cm
4. S4 = 30.1-50cm
5. S5 = 50.1-80cm
6. S6 = >80cm

*Mobility8/Home range coded as an ordered categorical variable with 3 levels:
1. Sed = sedentary
2. Mob = mobile within a reef
3. VMob = highly mobile i.e. between reefs

Period of *Activity* coded as an ordered categorical variable with 3 levels:
1. Day = diurnal
2. Both = diurnal & nocturnal
3. Night = nocturnal

Schooling coded as a categorical variable, 5 levels:
1. Sol = solitary
2. Pair = pairing
3. SmallG = small group
4. MedG = medium group
5. LargeG = large group

Position in the water column (*Level-water*) coded as an ordered categorical variable with 3 levels:
1. Bottom = bottom
2. Low = above bottom
3. High = pelagic

*Diet* coded as a categorical variable with 7 levels:
1. HD = herbivorous-detritivorous (undefined organic material, often grouped by many authors under the name detritus and/or undefined vegetal material, turf or filamentous algae)
2. HM = herbivorous macro-algal (macro algae (large fleshy algae) and sea grass)
3. IS = invertivorous sessile (sessile invertebrates: coral, sponge, ascidians and so on)
4. IM = invertivorous mobile (large benthic invertebrates + small benthic invertebrates + undefined invertebrates)
5. PK = planktonivorous (plankton and small organisms which migrate in the water column, such as many benthic copepods, amphipods, crustacean larvaes etc which migrate in the water column at night)
6. FC = Pelagic macro-organisms (large organisms living in the water column, usually fish and cephalopods) and benthic fish
7. OM = omnivorous (herbivorous and/or detritivorous AND carnivorous)


### Transformation
Many analyses require species matrix made up of rows and columns where each row is a site (or an environmental factor/covariate) and each column is a species.

```{r create species matrix}

med_mat <- raw_med %>% 
  group_by(species) %>% 
  mutate(grouped_id = row_number()) %>% # these two rows (group_by() and mutate()) are a workaround an error dplyr throws when there are multiple keys, i.e. the species, which is the column we'd like to spread, is not unique)
  spread(species, sp.n) %>% 
  select(-sp.length, -a, -b, -grouped_id) # these are irrelevant in this case but make sure to consider if you do need these variables
med_mat[, 18:136][is.na(med_mat[, 18:136])] <- 0 # change NAs to 0s only for species
head(med_mat)
# last column of metadata is 17
# species are in cols (18:136)

```


