---
title: "Data wrangling for Mediterranean dataset (Medata)"
author: "Shira Salingre"
output: html_document
---

```{r setup, include=FALSE}
# library(maps) # needed for map.where()
library(plotly)
library(tidyverse)

```

# Introduction
Medata is made up of fish census surveys conducted along the Mediterranean sea and collated into a unified dataset that includes information on the sites and the fish.

```{r setup data}
raw_med <- read.csv("med_raw.csv", na.strings = c("", "NA")) # na.string() is used to make sure all blanks and all NAs are counted as NA.

# create a sites list from all unique sites:
sites <- raw_med %>%
  distinct(site)

# same for locations (this one includes lon and lat)
locations <- raw_med %>%
  distinct(lon, lat)

# locations <- na.omit(locations) # omits NAs from locations, prep for next line of code:
# locations$country <- map.where(database = "world", locations$lon, locations$lat) # retrieves country for each point coordinate

# and one more for species
species <- raw_med %>% 
  distinct(species)

# list of NA longitudes:
lon_NA <- raw_med %>% 
  dplyr::distinct(site, lon, lat) %>% 
  filter(is.na(lon))

```


# Methods

## Data collection
Visual fish census surveys took place in 57 locations along the Mediterranean Sea (figure 1) by teams of skilled SCUBA divers. Locations were comprised of sites within MPAs with varying size, age and enforcement level, and unprotected sites which are adjacent to these MPAs. To date, the database is comprised of approximately 49,000 observations of 93 species of fish and includes abundance data, as well as presence-absence data. Additional data will be collected during 2019 and will be added to the main database.

```{r locations map}
sites_plot <- ggplot(data = raw_med, aes(x = lon, y = lat)) +
  geom_point(aes(colour = country)) + 
  xlab("") + ylab("")

ggplotly(sites_plot)

```
Figure 1. Sites where fish surveys were conducted.


```{r review it}
summary(raw_med) # examine raw data and check for errors.

```

'raw_med' is an extensive dataset which includes all data collected, in a long format (so each species in each site has its own row). Though it is called "raw data", it had actually already underwent a series of validations.

**`data.origin`**

*fct*

* azz_asi = Azzuro
* azz_malta = Azzuro
* Belmaker = Belmaker
* Claudet = Claudet
* Sala - PEW = Sala

**`country`**

*fct*

#ToDo: find code to retrieve country by coordinates

**`site`**

*fct*

`sites` lists the site names

**`lon` and `lat` - coordinates**

*num*

approximate locations for: Linosa, Kornati

`locations` lists the site names with their coordinates

**`trans`** = transect

*int*

number of transect.

**`species`** = species scientific name

*fct*

capital letter in the genus name, genus and species names are separated with a dot (.)
Some are not species but genus (followed by `spp.`) and some are families (one word, -dae suffix)

**`sp.length`**

*num*

The length of the fish in cm

**`sp.n`**

*int*

fish count - how many individuals of this species were observed?

**`season`**

*fct*; levels: `Autumn`, `Spring`, `Summer`
The season in which the survey was conducted

**`protection`** 

*fct*

Inside MPA = `YES`
Outside MPA = `NO`

**`enforcement`**

Type of enforcement:

*int* with 3 levels:

* `1` = Minimal protection
* `2` = Medium protection
* `3` = Fully protected

Complements `protection`

**`total.mpa.ha`**

*num*
Total MPA area in hactare
For Ustica - taken from: http://www.parks.it/indice/RM/Eindex.php

Marettimo is the west-most island in a large nature reserve called "Isola Egadi", which extends 53,992 ha, but contains ![zoning](http://www.ampisoleegadi.it/?idx=1620).

**`size.notake`**

*num*

Area size of no-take zone (in ha)
For Ustica - taken from: http://www.mmmpa.eu/UST-MPA.asp

**`yr.creation`**

*int*

MPA establishing year.

**`age.reserve.yr`**

*int*

The age of the MPA in years (corresponds to `yr.creation`)

**`depth`**

*num*

Depth of survey in metres

**`tmax`, `tmin`, `tmean`**

Temperature: maximum, minimum and mean
Data acquired from ![Bio Oracle](http://www.bio-oracle.org/index.php):
Tyberghein L, Verbruggen H, Pauly K, Troupin C, Mineur F, De Clerck O (2012) Bio-ORACLE: A global environmental dataset for marine species distribution modelling. Global Ecology and Biogeography, 21, 272–281.
Assis, J., Tyberghein, L., Bosh, S., Verbruggen, H., Serrão, E. A., & De Clerck, O. (2017). Bio-ORACLE v2.0: Extending marine data layers for bioclimatic modelling. Global Ecology and Biogeography.

**`a`**

*num*

species length-weight relationship constant

**`b`**

*num*

species length-weight relationship constant

## Data cleaning

* Linosa and kornati did not have specific coordinates, therefore, an approximate location (lat-lon) was attached to it. If your analysis requires fine-detail for the location, you might want to omit these locations.

* 

## Data wrangling

Many analyses require species matrix made up of rows and columns where each row is a site (or an environmental factor/covariate) and each column is a species.

```{r create species matrix}

med_mat <- raw_med %>% 
  group_by(species) %>% 
  mutate(grouped_id = row_number()) %>% # these two rows (group_by() and mutate()) are a workaround an error dplyr throws when there are multiple keys, i.e. the species, which is the column we'd like to spread, is not unique)
  spread(species, sp.n) %>% 
  select(-sp.length, -a, -b, -grouped_id) # these are irrelevant in this case but make sure to consider if you do need these variables
med_mat[, 18:136][is.na(med_mat[, 18:136])] <- 0 # change NAs to 0s only for species
head(med_mat)
# last column of metadata is 17
# species are in cols (18:136)

```


