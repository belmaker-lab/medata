---
title: "Data wrangling for Mediterranean dataset (Medata)"
author: "Shira Salingre"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)

```

Medata is made up of fish census surveys conducted along the Mediterranean sea and collated into a unified dataset that includes information on the sites and the fish.

```{r upload raw data and review it}
raw_med <- read.csv("med_raw.csv", na.strings = c("", "NA")) # na.string() is used to make sure all blanks and all NAs are counted as NA.
summary(raw_med) # examine raw data and check for errors.
```

'raw_med' is quite an extensive dataset and it includes all data collected, in a long format (so each species in each site has its own row). Though it is called "raw data", it had actually already undergo a series of validations (which are not done yet!).

**`data.origin`**

*fct*

* azz_asi = Azzuro
* azz_malta = Azzuro
* Belmaker = Belmaker
* Claudet = Claudet
* rilov = Rilov
* Sala - PEW = Sala

**`country`**

*fct*

#ToDo: find code to retrieve country by coordinates

**`site`**

*fct*

#ToDo: change blanks to "Banyuls_Unknown" (make sure it's all France and same coords)
`sites` (next code chunk) lists the site names

**`lon` and `lat` - coordinates**

*num*

#ToDo 1258 NAs - needs completing (many are *Linosa* site, no coords, should we take approx.?)
`locations` (next code chunk) lists the site names with their coordinates

**`trans`** = transect

*int*

number of transect.

**`species`** = species scientific name

*fct*

capital letter in the genus name, genus and species names are separated with a dot (.)
Some are not species but genus (followed by `spp.`) and some are families (one word, -dae suffix)

**`sp.length`**

*num*

The length of the fish in cm

**`sp.n`**

*int*

fish count - how many individuals of this species were observed?

**`season`**

*fct*; levels: `Autumn`, `Spring`, `Summer`
The season in which the survey was conducted

**`protection`** 

*fct*

Inside MPA = `YES`
Outside MPA = `NO`

**`enforcement`**

Type of enforcement:

*int* with 3 levels:

* `1` = Minimal protection
* `2` = Medium protection
* `3` = Fully protected

Complements `protection`

**`total.mpa.ha`**

*num*
Total MPA area in hactare
# ToDo: complete NAs

**`size.notake`**

*num*
Area size of no-take zone (in ha)
# ToDo: complete NAs

**`yr.creation`**

*int*

MPA establishing year.
# ToDo: complete NAs

**`age.reserve.yr`**

*int*

The age of the MPA in years (corresponds to `yr.creation`)
# ToDo: complete NAs

**`depth`**

*num*

Depth of survey in metres
# ToDo: complete NAs from abthymetry maps?

**`tmax`, `tmin`, `tmean`**

Temperature: maximum, minimum and mean
taken from GMED
# ToDo: complete NAs from GMED

**`a`**

*num*

species length-weight relationship constant

**`b`**

*num*

species length-weight relationship constant


```{r create lists of variables}

# create a sites list from all unique sites:
sites <- raw_med %>%
  distinct(site)

# same for locations (this one includes lon and lat)
locations <- raw_med %>%
  distinct(lon, lat)

locations <- na.omit(locations) # omits NAs from locations, prep for next line of code:
locations$country <- map.where(database = "world", locations$lon, locations$lat) # retrieves country for each point coordinate

# and one more for species
species <- raw_med %>% 
  distinct(species)

```


Many analyses require species matrix made up of rows and columns where each row is a site (or an environmental factor/covariate) and each column is a species.

```{r create species matrix}

med_mat <- raw_med %>% 
  group_by(species) %>% 
  mutate(grouped_id = row_number()) %>% # these two rows (group_by() and mutate()) are a workaround an error dplyr throws when there are multiple keys, i.e. the species, which is the column we'd like to spread, is not unique)
  spread(species, sp.n) %>% 
  select(-sp.length, -a, -b, -grouped_id) # these are irrelevant in this case but make sure to consider if you do need these variables
med_mat[, 18:136][is.na(med_mat[, 18:136])] <- 0 # change NAs to 0s only for species
head(med_mat)
# last column of metadata is 17
# species are in cols (18:136)

```


