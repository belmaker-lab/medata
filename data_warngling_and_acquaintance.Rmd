---
title: "Data wrangling for Mediterranean dataset (Medata)"
author: "Shira Salingr√©"
output: html_document
---

```{r setup, include=FALSE}
library(ggmap)
library(plotly)
library(tidyverse)

```

# Introduction
Medata is made up of fish census surveys conducted along the Mediterranean sea and collated into a unified dataset that includes information on the sites and the fish.

```{r setup data}
raw_med <- read.csv("med_raw.csv", na.strings = c("", "NA")) # na.string() is used to make sure all blanks and all NAs are counted as NA.

# create a sites list from all unique sites:
sites <- raw_med %>%
  distinct(site)

# same for locations (this one includes lon and lat)
locations <- raw_med %>%
  distinct(lon, lat)

# locations <- na.omit(locations) # omits NAs from locations, prep for next line of code:
# locations$country <- map.where(database = "world", locations$lon, locations$lat) # retrieves country for each point coordinate

# and one more for species
species <- raw_med %>% 
  distinct(species)

```


# Methods

## Data collection
Visual fish census surveys took place in 57 locations along the Mediterranean Sea (figure 1) by teams of skilled SCUBA divers. Locations were comprised of sites within MPAs with varying size, age and enforcement level, and unprotected sites which are adjacent to these MPAs. To date, the database is comprised of approximately 49,000 observations of 93 species of fish and includes abundance data, as well as presence-absence data. Additional data will be collected during 2019 and will be added to the main database.

```{r locations map}
extent_medit <- c(-5.353764, 36.21573, 30.06809, 45.80891)
memory.limit(size = 20000)

medit_map <- get_map(location = extent_medit, zoom = 6, maptype = "watercolor", source = "stamen")

sites_plot <- ggplot(data = raw_med, aes(x = lon, y = lat, z = tmean, text = site)) +
  geom_point(aes(colour = country)) + 
  xlab("") + ylab("")

ggplotly(sites_plot, tooltip = c("site", "tmean", "country"))

```
Figure 1. Survey sites.


```{r review it}
summary(raw_med) # examine raw data and check for errors.

```

'raw_med' is an extensive dataset which includes all data collected, in a long format (so each species in each site has its own row). Though it is called "raw data", it had actually already underwent a series of validations.

| Column name    | type  | comments     |
| :------------- | :---: | -----------: |
|  `data.origin` | *fct* | azz_asi = Azzuro; azz_malta = Azzuro; Belmaker = Belmaker; Claudet = Claudet; Sala - PEW = Sala |
| `country`      | *fct* | Country where `site` is located |
| `sites`        | *fct* | site names   |
| `lon`          | *num* | longitude (degrees); approximate for Linosa, Kornati|
| `lat`          | *num* | latitude (degrees); approximate for Linosa, Kornati |
| `trans`        | *int* | transect number |
| `species`      | *fct* | species scientific name (*Genus.species*); some species are recognised to Genus (spp)  or Family (-dae suffix) level |
| `sp.length`    | *num* | length of fish in cm |
| `sp.n`         | *int* | fish count - how many individuals of this species were observed? |
| `season`       | *fct* | levels: `Autumn`, `Spring`, `Summer` - The season in which the survey was conducted |
| `protection`   | *fct* | inside MPA = `YES`; outside MPA = `NO` |
| `enforcement`  | *int* | type of enforcement. 3 levels: `1` = Minimal protection; `2` = Medium protection; `3` = Fully protected. Complements `protection` |
| `total.mpa.ha` | *num* | total MPA area in hactare; ![Source for Ustica](http://www.parks.it/indice/RM/Eindex.php); ![Source for Marettimo](http://www.ampisoleegadi.it/?idx=1620) |
| `size.notake`  | *num* | area size of no-take zone (in ha); ![Source for Ustica](http://www.mmmpa.eu/UST-MPA.asp) |
| `yr.creation`  | *int* | MPA establishment year |
| `age.reserve.yr`| *int* | age of the MPA in years (corresponds to `yr.creation`) |
| `depth`        | *num* | depth of survey in metres (where applicable) |
| `tmax`         | *num* | maximum temperature (Source: ![Bio-ORACLE](http://www.bio-oracle.org/index.php)) |
| `tmin`         | *num* | minimum temperature (Source: ![Bio-ORACLE](http://www.bio-oracle.org/index.php)) |
| `tmean`        | *num* | mean temperature (Source: ![Bio-ORACLE](http://www.bio-oracle.org/index.php)) |
| `a`            | *num* | species length-weight relationship constant |
| `b`            | *num* | species length-weight relationship constant |

## Data cleaning

* Linosa and kornati did not have specific coordinates, therefore, an approximate location (lat-lon) was attached to it. If your analysis requires fine-detail for the location, you might want to omit these locations.

* 

## Data wrangling

Many analyses require species matrix made up of rows and columns where each row is a site (or an environmental factor/covariate) and each column is a species.

```{r create species matrix}

med_mat <- raw_med %>% 
  group_by(species) %>% 
  mutate(grouped_id = row_number()) %>% # these two rows (group_by() and mutate()) are a workaround an error dplyr throws when there are multiple keys, i.e. the species, which is the column we'd like to spread, is not unique)
  spread(species, sp.n) %>% 
  select(-sp.length, -a, -b, -grouped_id) # these are irrelevant in this case but make sure to consider if you do need these variables
med_mat[, 18:136][is.na(med_mat[, 18:136])] <- 0 # change NAs to 0s only for species
head(med_mat)
# last column of metadata is 17
# species are in cols (18:136)

```


